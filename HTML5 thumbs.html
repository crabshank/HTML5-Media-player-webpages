<html> 

<head>
<script src="jquery-3.4.1.min.js"></script>
</head> 

<body>

<style>
video{
	width:90%; 
	height:auto; 
	background:#000;
}
video::-webkit-media-controls {
    zoom: 131%;
}
figcaption {
color: white;
    font-size: 169%;
    display: inline-table;
    position: absolute;
    transform-origin: top left;
    font-family: Microsoft JhengHei UI;
}
div#thumbs>figure {
    display: inline-grid;
		margin: 0 0 0 0;
}
button, input[type="button"]{
	background-color: buttonface;
}

body{
background-color: #333;
}

span{
color: #dfdfdf;
}

input::-webkit-textfield-decoration-container {
    background: buttonface;
}
</style>

<button onclick="setPlusFrames()" type="button">+ 3 thumbs</button>
<button onclick="setMinusFrames()" type="button">- 3 thumbs</button>
<button onclick="setEveryFrames()" type="button" id="every" style="display: none;"></button>
<button onclick="clr()" type="button">Clear</button>
<input type="text" style="width: 52.6%;" name="txtBx" id="txtBx">

<input type="button" Value="Load Video" onClick="changeValue();">
<input type="button" Value="Generate Thumbs" onClick="doThumbs();"><br>
<span id="frames" title="Scroll here to change number of frames.">24</span>
<span style="margin-inline-start: 4.4ch;" title="Maximum speed when speeding through; scroll to change.">Max speed: </span><input title="Maximum speed when speeding through; scroll to change." type="number" id="mxs" min="1" max="16" step="0.5" value="6" style="width: 9ch; background-color: buttonface; border-width: 0px;"></input>

<div style="width:90%; text-align:center;">


<video id="video" style="width:90%;" controls>
    <source id="VdoSrc" src=""></source>
</video><button id="scroll_curr" style="position: fixed; margin-left: 1px; visibility: hidden;">Scroll to current thumb</button><button id="scroll_vid" style="position: fixed; margin-left: 1px;">Scroll to video</button><button id="spdt" style="position: fixed; margin-left: 1px;">Speed through video</button><button id="pnp" style="position: fixed; margin-left: 1px;">Toggle picture-in-pictue</button>

<div id="currTime" style="position: fixed; bottom: 0.17%; right: 0.73%; color: white; background-color: black; font-size: 185%; font-weight: bold;"></div>

<div id="thumbs"style="margin-block-start: 0.1%;"></div>

<script>
var clck_a=-1;
var t_a=0;
var clck_b=0;
var m_c=0;
var m_l=0;
var curr_thumb=0;
var t=24;
var done_t=t;
var loadFlag=false;
var nowFlag=-1;
var aseek=0;
var captions=[];
var ttmp=0;
var cap=-1;
var time_track=-1;
var tTrkFlg=false;
var ev_t=-1;
var frame_btn=document.getElementById("frames");
var mxsp=document.getElementById("mxs");
var thumbs=document.getElementById("thumbs");
var myVdo = document.getElementById("video");	
var scrl= document.getElementById("scroll_curr");
var scrv= document.getElementById("scroll_vid");
var spb= document.getElementById("spdt");
var pip= document.getElementById("pnp");
var evry= document.getElementById("every");
var scr_swtch=1;
var sp_swtch=0;
scrv.style.top=(myVdo.clientHeight+27)+'px';
scrl.style.top=(scrv.getBoundingClientRect().height+scrv.getBoundingClientRect().top+0.5)+'px';
spb.style.top=(myVdo.clientHeight+25-scrl.offsetHeight)+'px';
pip.style.top=(scr_swtch==1)?(myVdo.clientHeight+28+spb.offsetHeight)+'px':(myVdo.clientHeight+28+spb.offsetHeight+scrv.offsetHeight)+'px';

function calcSp(){
if(sp_swtch==1 && aseek==0 && mxsp.valueAsNumber>1 && !myVdo.paused){ 
if(clck_a==-1){
		t_a=myVdo.currentTime;
	clck_a = performance.now();
}else{
let c_i=myVdo.currentTime;
clck_b = performance.now();
for (let i=myVdo.buffered.length-1; i>=0; i--){	
let t_i=myVdo.buffered.end(i);
let s_i=myVdo.buffered.start(i);
if(c_i<=t_i && c_i>=s_i){
	if(t_i>t_a){
		lst=Math.floor((100000*((t_i-t_a)/(clck_b-clck_a))))*0.01;
		t_a=t_i;
		myVdo.playbackRate=Math.min(mxsp.value,Math.max(1,lst));
	}else{
		t_a=c_i
	}
	clck_a=performance.now();
	break;
}else if(c_i>t_i){
	break;
}

}
}

}
}

function adjRate(){
if(sp_swtch==1){
myVdo.playbackRate=Math.min(16,Math.max(1,mxsp.valueAsNumber));
calcSp();
}
}

function skip(event) {
event=(event.originalEvent)?event.originalEvent:event;
event.preventDefault();
event.stopPropagation();
if(event.deltaY>0){
   myVdo.currentTime -= (myVdo.duration/t)*0.05;
}
if (event.deltaY<0){
	myVdo.currentTime +=  (myVdo.duration/t)*0.05;
}
}

window.addEventListener('resize', function () {
let factor= ((100/3)*(myVdo.clientWidth/myVdo.videoWidth));
thumbs.style.zoom=factor.toLocaleString('en', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"%";
scrv.style.top=(myVdo.clientHeight+27)+'px';
scrl.style.top=(scrv.getBoundingClientRect().height+scrv.getBoundingClientRect().top+0.5)+'px';
spb.style.top=(myVdo.clientHeight+25-scrl.offsetHeight)+'px';
pip.style.top=(scr_swtch==1)?(myVdo.clientHeight+28+spb.offsetHeight)+'px':(myVdo.clientHeight+28+spb.offsetHeight+scrv.offsetHeight)+'px';
});

var curr  =document.getElementById("currTime");
var txtBx = document.getElementById('txtBx');
var vid = document.getElementById('VdoSrc');

function formatTime(seconds,precise) {
var minutes = Math.floor(seconds / 60);
var secs = seconds % 60;
let floorSecs =Math.floor(secs);
if (typeof precise!=='undefined'){
	minutes +="m";
if(precise==1){
secs =Math.ceil((secs-floorSecs) *10);
secs=(secs==10)?" "+(floorSecs+1)+".0s":" "+floorSecs+"."+Math.max(0,secs).toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0})+"s";
}else if(precise==2){
	secs =Math.ceil((secs-floorSecs) *1000);
	secs=(secs==1000)?" "+(floorSecs+1)+"s 0ms":" "+floorSecs+"s "+Math.max(0,secs).toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0})+"ms";
	}
}else{
	minutes=(minutes < 10) ? "0" + minutes: minutes;
	secs = (floorSecs < 10) ? ":0" + floorSecs:":"+floorSecs ;
}

	return minutes + secs;
  }

$("#thumbs").ready(function() {
  $("#thumbs").on("click", "figure", function() {
    var index = $("figure").index(this);
	nowFlag=index;
	cap=index;
	  //console.log($(('#thumbs > figure > canvas')[index]));

myVdo.currentTime = $('#thumbs > figure')[index].querySelector('canvas').attributes.timestamp.nodeValue;
if (!document.pictureInPictureElement) {
		 window.scrollTo(0,0);
		 }
  });
  
scrl.onclick=function(){
if(scr_swtch==0){
$('#thumbs > figure')[curr_thumb].scrollIntoView();
}
};

scrv.onclick=function(){
window.scrollTo(0,0);
};

mxsp.onwheel= (event) => {
	event.preventDefault();
	event.stopPropagation();
	
	if(event.deltaY>0){
		mxsp.value=(Math.max(1,mxsp.valueAsNumber-parseFloat(mxsp.step))).toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7});
		adjRate();
	}
	if (event.deltaY<0){
		mxsp.value=(Math.min(16,mxsp.valueAsNumber+parseFloat(mxsp.step))).toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7});
		adjRate();
		}
	}
	
	mxsp.onchange= (event) => {
		adjRate();
	}	
	mxsp.oninput= (event) => {
		adjRate();
	}
	mxsp.onkeyup= (event) => {
		adjRate();
	}
	mxsp.onkeydown= (event) => {
		adjRate();
	}

myVdo.onwheel= (event) => {
skip(event);
}


myVdo.onprogress= () => {
if(myVdo.readyState>2){
calcSp();
}else{
myVdo.playbackRate=1;
}
}


myVdo.onplay= () => {
if(myVdo.readyState>2){
calcSp();
}else{
myVdo.playbackRate=1;
}
}


myVdo.onseeked= () => {
t_a=myVdo.currentTime;
if(myVdo.readyState>2){
calcSp();
}else{
myVdo.playbackRate=1;
}
}

 myVdo.ontimeupdate= () => {
	if(!tTrkFlg){
 	curr.innerText= formatTime(myVdo.currentTime)+"\n("+myVdo.playbackRate.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"x)";
	}
}

spb.onclick=function(){
if(sp_swtch==0){
sp_swtch=1;
adjRate();
spb.innerText="Play at 1x";
}else{
myVdo.playbackRate=1;
sp_swtch=0;
spb.innerText="Speed through video";
}
};

pip.onclick=function(){
if (document.pictureInPictureElement) {
document.exitPictureInPicture();
} else {
if (document.pictureInPictureEnabled) {
myVdo.requestPictureInPicture();
}
}
};


  
});

frame_btn.onwheel= (event) => {

event.preventDefault();
event.stopPropagation();

if(event.deltaY>0){
setMinusFrames();
}
if (event.deltaY<0){
setPlusFrames();
}

}



	function setPlusFrames() {
	if (aseek==0){
			t += 3;
			frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			if(ev_t>-1 && t!=ev_t){
				evry.style.display='initial';
			}else{
				evry.style.display='none';
			}
			}
	}

	function setMinusFrames() {
		if (aseek==0){
		t=(t<6)?3:t-3;
		frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			if(ev_t>-1 && t!=ev_t){
				evry.style.display='initial';
			}else{
				evry.style.display='none';
			}
		}
	}	
	
	function setEveryFrames() {
		if (aseek==0){
			if(myVdo.duration>=270){
			t=Math.round(Math.ceil(myVdo.duration/90)*3);
			frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;			
			}else if(myVdo.duration<4.5){
				t=Math.round(Math.Max(1,Math.floor((myVdo.duration*2)/3))*3);
				frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			}else{
			t=9;
			frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			}
			if(ev_t>-1 && t!=ev_t){
				evry.style.display='initial';
			}else{
				evry.style.display='none';
			}
		}
	}

function clr(){
document.getElementById('txtBx').value="";
}


	
var checkDur = function() {
	if(!!isFinite(myVdo.duration)){
	loadFlag=true;
	nowFlag=-1;	
			if(myVdo.duration>=270){
			t=Math.round(Math.ceil(myVdo.duration/90)*3);
			frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			evry.innerText='At least every 30 secs';
			}else if(myVdo.duration<4.5){
				t=Math.round(Math.Max(1,Math.floor((myVdo.duration*2)/3))*3);
				frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
				evry.innerText='At most every 0.5 secs';
			}else{
			let t=9;
			frame_btn.innerHTML =(loadFlag===true)?t+" - Thumbnails every: "+formatTime(myVdo.duration/t,2):t;
			evry.innerText='9 frames';
			}
			ev_t=t;
	}
	myVdo.currentTime=0;
	scrv.style.top=(myVdo.clientHeight+27)+'px';
	scrl.style.top=(scrv.getBoundingClientRect().height+scrv.getBoundingClientRect().top+0.5)+'px';
	spb.style.top=(myVdo.clientHeight+25-scrl.offsetHeight)+'px';
	pip.style.top=(scr_swtch==1)?(myVdo.clientHeight+28+spb.offsetHeight)+'px':(myVdo.clientHeight+28+spb.offsetHeight+scrv.offsetHeight)+'px';
	if(!tTrkFlg){
	curr.innerText= formatTime(myVdo.currentTime)+"\n("+myVdo.playbackRate.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"x)";
	}
}


function changeValue()
{
	curr_thumb=0;
	loadFlag=false;
	ttmp=0;
	let txtVal=txtBx.value;
    alert(txtVal);  
    vid.src = txtVal;      
    myVdo.load(); 
	myVdo.pause();
  	captions=[];
	curr_thumb=0;
	thumbs.innerHTML="";
	scr_swtch=1;
	scrl.style.visibility='hidden';
	pip.style.top=(myVdo.clientHeight+28+spb.offsetHeight)+'px';
	checkDur();

}

myVdo.ondurationchange= () => {
  checkDur();
}

myVdo.onloadedmetadata= () => {
  checkDur();
}
  
   myVdo.onratechange =function() {
	if(!tTrkFlg){
 	curr.innerText= formatTime(myVdo.currentTime)+"\n("+myVdo.playbackRate.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"x)";
	}
	if(myVdo.readyState>2){
	calcSp();
	}
 }


function doThumbs()
{
	
if (loadFlag===true){
	 done_t=t;
captions=[];
thumbs.innerHTML="";

myVdo.load(); 

aseek=1;

if(!tTrkFlg){
curr.innerText= formatTime(myVdo.currentTime)+"\n("+myVdo.playbackRate.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"x)";
}

 myVdo.ontimeupdate= () => {
	if(!tTrkFlg){
 	curr.innerText= formatTime(myVdo.currentTime)+"\n("+myVdo.playbackRate.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"x)";
	}
 if(aseek==0){
	for(let i=0;i<captions.length;i++){
	captions[i].innerText=captions[i].previousSibling.attributes.timestamp_fmt.nodeValue;
	captions[i].style.backgroundColor="#00000099";
	}
	
	cap=(cap!=-1)?cap:myVdo.currentTime*(done_t)/myVdo.duration;
	let cap_el=Math.floor(cap);
	let perc=Math.min(100,Math.max(0,(cap-cap_el)*100)).toLocaleString('en-GB', {minimumFractionDigits: 1, maximumFractionDigits: 1});

	
if(captions.length==done_t){

if (cap_el<captions.length){
var attr=captions[cap_el].previousSibling.attributes;
}else if (cap_el>=captions.length){
var attr=captions[captions.length-1].previousSibling.attributes;
}

if(nowFlag>-1){
var attr_now=captions[nowFlag].previousSibling.attributes;
}

if (cap_el+1<captions.length){
var attr_next=captions[cap_el+1].previousSibling.attributes;
	if(nowFlag>-1){
			captions[nowFlag].innerText=attr_now.timestamp_fmt.nodeValue+" (NOW!)";
			curr_thumb=nowFlag;
			captions[nowFlag].style.backgroundColor="#0004ff99";
	}else if (cap==cap_el){
			captions[cap_el].innerText=attr.timestamp_fmt.nodeValue+" (NOW!)";
			curr_thumb=cap_el;
			captions[cap_el].style.backgroundColor="#0004ff99";
	}else{
		var until=(cap_el<captions.length)?Math.max(0,attr_next.timestamp.nodeValue-myVdo.currentTime):Math.max(0,myVdo.duration-myVdo.currentTime);
		until=formatTime(until,1);
			captions[cap_el+1].innerText=attr_next.timestamp_fmt.nodeValue+" (NEXT) ["+until+"]";
			captions[cap_el].innerText=attr.timestamp_fmt.nodeValue+" (LAST) ["+perc+"%]";
			curr_thumb=cap_el;
			captions[cap_el].style.backgroundColor="#006115c7";
	}
}else{

	if(nowFlag>-1){
			captions[nowFlag].innerText=attr_now.timestamp_fmt.nodeValue+" (NOW!)";
			curr_thumb=nowFlag;
			captions[nowFlag].style.backgroundColor="#0004ff99";
	}else if (cap==cap_el){
		if(cap_el>=captions.length){
			captions[captions.length-1].innerText=attr.timestamp_fmt.nodeValue+" (LAST) ["+100+".0%]";
			curr_thumb=captions.length-1;
			captions[captions.length-1].style.backgroundColor="#006115c7";
		}else{
		captions[cap_el].innerText=attr.timestamp_fmt.nodeValue+" (NOW!)";
		curr_thumb=cap_el;
		captions[cap_el].style.backgroundColor="#0004ff99";
		}
	}else{
			captions[captions.length-1].innerText=attr.timestamp_fmt.nodeValue+" (LAST) ["+perc+"%]";
			curr_thumb=captions.length-1;
			captions[captions.length-1].style.backgroundColor="#006115c7";
	}
		
}
}
cap=-1;
}
 }

myVdo.onloadeddata= function() {
	if (captions.length==0){
	ttmp=0;
	thumbs.innerHTML = "";
	myVdo.currentTime = 0;
	} 
}
 
function thumbseek(bool){
	if(bool){
		if(!((ttmp==0)&&(myVdo.readyState<2))){
			time_track =ttmp*(myVdo.duration/t);
			generateThumbnail();
			ttmp++;
			if (ttmp<done_t) {
			tTrkFlg=true;
			curr.innerText= formatTime(myVdo.currentTime)+"\n"+ttmp+"/"+done_t;
			myVdo.currentTime = ttmp*(myVdo.duration/t);
			}else {
				aseek=0;
				tTrkFlg=false;
				time_track=-1;
				ttmp=0;
				myVdo.currentTime=0;
				scr_swtch=0;
				pip.style.top=(myVdo.clientHeight+28+spb.offsetHeight+scrv.offsetHeight)+'px';
				scrl.style.visibility='';
				window.scrollTo(0,0);
			}
		}
		 
	}else{
		nowFlag=-1;
	}


}
 
myVdo.onseeking=function(){
	if((aseek==1)&&(myVdo.readyState>=2)&&(myVdo.currentTime>time_track)){  
		thumbseek(true);
	}else{
		thumbseek(false);
	}
}

myVdo.onwating=function(){
myVdo.playbackRate=1;
	if((aseek==1)&&(myVdo.readyState>=2)&&(myVdo.currentTime>time_track)){  
		thumbseek(true);
	}else{
		thumbseek(false);
	}
} 

myVdo.onseeked= function(){
t_a=myVdo.currentTime;
if(myVdo.readyState>2){
calcSp();
}else{
myVdo.playbackRate=1;
}

	if((aseek==1)&&(myVdo.currentTime>time_track)){  
		thumbseek(true);
	}else{
		thumbseek(false);
	}
}
 
function generateThumbnail() {

var f = document.createElement("figure");
var ct=document.createElement("figcaption");
var c = document.createElement("canvas");

f.onwheel= (event) => {
$('#thumbs > figure')[curr_thumb].scrollIntoView();
skip(event);
}


var ctx = c.getContext("2d");

let v_width = myVdo.videoWidth;
let v_height = myVdo.videoHeight;

c.width= v_width;
c.height=v_height;   

f.style.width= v_width;
f.style.height=v_height;

c.setAttribute('timestamp', myVdo.currentTime);
let format_time=formatTime(myVdo.currentTime);
c.setAttribute('timestamp_fmt', format_time);

ctx.drawImage(myVdo, 0, 0, v_width, v_height);
let factor=((100/3)*(myVdo.clientWidth/v_width));
thumbs.style.zoom=factor.toLocaleString('en', {minimumFractionDigits: 0, maximumFractionDigits: 7})+"%";
scrv.style.top=(myVdo.clientHeight+27)+'px';
scrl.style.top=(scrv.getBoundingClientRect().height+scrv.getBoundingClientRect().top+0.5)+'px';
spb.style.top=(myVdo.clientHeight+25-scrl.offsetHeight)+'px';
pip.style.top=(scr_swtch==1)?(myVdo.clientHeight+28+spb.offsetHeight)+'px':(myVdo.clientHeight+28+spb.offsetHeight+scrv.offsetHeight)+'px';
thumbs.appendChild(f);

f.appendChild(c);
ct.innerHTML=format_time;
f.appendChild(ct);
captions.push(ct);
ct.style.cssText+="transform: scale("+(0.18*(f.clientWidth/ct.clientWidth)).toLocaleString('en', {minimumFractionDigits: 0, maximumFractionDigits: 7})+");";
}
  
}else{
alert('Video not loaded!');
}

}

</script>

</body> 

</html>